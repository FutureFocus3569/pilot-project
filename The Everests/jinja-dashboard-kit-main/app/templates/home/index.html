{% extends "layouts/base.html" %}

{% block title %} Dashboard {% endblock %} 

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %}


{% block content %}

    <!-- Monthly Occupancy Section -->
    <div class="pc-container">
        <div class="pcoded-content">
            {% include "includes/monthly_occupancy.html" %}

            <!-- [ breadcrumb ] start -->
            <div class="page-header">
                <div class="page-block">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="page-header-title">
                                <h5 class="m-b-10">Dashboard sale</h5>
                            </div>
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                                <li class="breadcrumb-item">Dashboard sale</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- [ breadcrumb ] end -->
            <!-- [ Main Content ] start -->
            <div class="row">
                <!-- support-section start -->
                <div class="col-xl-6 col-md-12">
                    <div class="card flat-card">
                        <div class="row-table">
                            <div class="col-sm-6 card-body br">
                                <div class="row">
                                    <div class="col-sm-4">
                                        <i class="material-icons-two-tone text-primary mb-1">group</i>
                                    </div>
                                    <div class="col-sm-8 text-md-center">
                                        <h5>1000</h5>
                                        <span>Customers</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 d-none d-md-table-cell d-lg-table-cell d-xl-table-cell card-body br">
                                <div class="row">
                                    <div class="col-sm-4">
                                        <i class="material-icons-two-tone text-primary mb-1">language</i>
                                    </div>
                                    <div class="col-sm-8 text-md-center">
                                        <h5>$1252</h5>
                                        <span>Revenue</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 card-body">
                                <div class="row">
                                    <div class="col-sm-4">
                                        <i class="material-icons-two-tone text-primary mb-1">unarchive</i>
                                    </div>
                                    <div class="col-sm-8 text-md-center">
                                        <h5>600</h5>
                                        <span>Growth</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row-table">
                            <div class="col-sm-6 card-body br">
                                <div class="row">
                                    <div class="col-sm-4">
                                        <i class="material-icons-two-tone text-primary mb-1">swap_horizontal_circle</i>
                                    </div>
                                    <div class="col-sm-8 text-md-center">
                                        <h5>3550</h5>
                                        <span>Returns</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 d-none d-md-table-cell d-lg-table-cell d-xl-table-cell card-body br">
                                <div class="row">
                                    <div class="col-sm-4">
                                        <i class="material-icons-two-tone text-primary mb-1">cloud_download</i>
                                    </div>
                                    <div class="col-sm-8 text-md-center">
                                        <h5>3550</h5>
                                        <span>Downloads</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 card-body">
                                <div class="row">
                                    <div class="col-sm-4">
                                        <i class="material-icons-two-tone text-primary mb-1">shopping_cart</i>
                                    </div>
                                    <div class="col-sm-8 text-md-center">
                                        <h5>100%</h5>
                                        <span>Order</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <!-- Removed Conversion Rate and Order Delivered sections -->
                    </div>
                </div>
                <div class="col-xl-6 col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>Department wise monthly sales report</h5>
                        </div>
                        <div class="card-body">
                            <div class="row pb-2">
                                <div class="col-auto m-b-10">
                                    <h3 class="mb-1">$21,356.46</h3>
                                    <span>Total Sales</span>
                                </div>
                                <div class="col-auto m-b-10">
                                    <h3 class="mb-1">$1935.6</h3>
                                    <span>Average</span>
                                </div>
                            </div>
                            <div id="account-chart"></div>
                        </div>
                    </div>
                </div>
                <!-- Monthly Occupancy Section -->
                <div class="col-12 mt-4">
                    <div class="card p-4" style="background:#f8f9fa;">
                        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-3">
                            <div>
                                <h4 class="mb-1">Childcare Centers Overview</h4>
                                <div class="text-muted" style="font-size:1em;">Live occupancy data for all 6 centers - automatically updated Monday to Friday at 5am NZT</div>
                            </div>
                            <div class="d-flex align-items-center mt-3 mt-md-0">
                                <button id="month-back" class="btn btn-outline-secondary btn-sm me-2">&#60;</button>
                                <span id="month-label" class="fw-bold px-2" style="font-size:1.1em;">Month</span>
                                <button id="month-forward" class="btn btn-outline-secondary btn-sm ms-2">&#62;</button>
                            </div>
                        </div>
                        <div class="mb-3 text-center">
                            <span class="fw-bold" style="font-size:1.1em;">Average Occupancy</span>
                            <span id="avg-u2" class="ms-3" style="color:#0d8abc;">U2: --</span>
                            <span id="avg-o2" class="ms-3" style="color:#43a047;">O2: --</span>
                            <span id="avg-total" class="ms-3" style="color:#fbc02d;">Total: --</span>
                        </div>
                        <div class="row g-4" id="monthly-occupancy-row">
                            <!-- Occupancy cards will be rendered here -->
                        </div>
                    </div>
                </div>
                <!-- support-section end -->
                <!-- customer-section start -->
                <!-- Removed Customer Satisfaction section -->
                <!-- Removed New Products and Feeds sections -->
                </div>
                <!-- customer-section end -->
            </div>
            <!-- [ Main Content ] end -->
        </div>
    </div>
    <!-- [ Main Content ] end -->


    <style>
    .occupancy-card { box-shadow: 0 2px 8px rgba(30,200,233,0.08), 0 1.5px 6px rgba(0,0,0,0.04); border-radius: 1.1rem; transition: box-shadow 0.2s; }
    .occupancy-card:focus, .occupancy-card:hover { box-shadow: 0 4px 16px rgba(30,200,233,0.18), 0 3px 12px rgba(0,0,0,0.10); outline: 2px solid #1de9b6; }
    .donut-chart { width: 110px; height: 110px; margin: 0 auto; }
    .donut-label { font-size: 1.1em; font-weight: 600; margin-top: 0.5em; letter-spacing: 1px; }
    .donut-value { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 1.3em; font-weight: bold; color: #333; pointer-events: none; }
    .donut-container { position: relative; display: inline-block; }
    </style>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script>
    // Utility: get unique months from data
    function getUniqueMonths(data) {
        const months = Array.from(new Set(data.map(row => row.month)));
        months.sort();
        return months;
    }

    // Utility: get unique centres from data
    function getUniqueCentres(data) {
        const centres = Array.from(new Set(data.map(row => row.centreName)));
        return centres;
    }

    // Calculate averages
    function getAverages(data) {
        let u2s = data.map(d => d.u2).filter(v => typeof v === 'number');
        let o2s = data.map(d => d.o2).filter(v => typeof v === 'number');
        let totals = data.map(d => d.total).filter(v => typeof v === 'number');
        let avg = arr => arr.length ? Math.round(arr.reduce((a,b)=>a+b,0)/arr.length) : '--';
        return {
            u2: avg(u2s),
            o2: avg(o2s),
            total: avg(totals)
        };
    }

    // Render donut chart
    function renderDonutChart(containerId, value, color) {
        // Only render chart if value is a valid number
        let valid = typeof value === 'number' && !isNaN(value);
        var el = document.querySelector('#'+containerId);
        if (valid) {
            var options = {
                chart: { type: 'donut', width: 110, height: 110, sparkline: { enabled: true } },
                series: [value, 100-value],
                labels: ['',''],
                colors: [color, '#e9ecef'],
                dataLabels: { enabled: false },
                legend: { show: false },
                stroke: { width: 0 },
                plotOptions: {
                    pie: {
                        donut: {
                            size: '80%',
                            labels: {
                                show: true,
                                name: { show: false },
                                value: { show: false },
                                total: { show: false }
                            }
                        }
                    }
                },
                tooltip: { enabled: false }
            };
            var chart = new ApexCharts(el, options);
            chart.render();
            // Add value in center
            setTimeout(function() {
                if (el && !el.querySelector('.donut-value')) {
                    let span = document.createElement('span');
                    span.className = 'donut-value';
                    span.innerText = value + '%';
                    el.appendChild(span);
                }
            }, 300);
        } else {
            // Show 'No data' if value is missing or invalid
            el.innerHTML = '';
            let span = document.createElement('span');
            span.className = 'donut-value';
            span.innerText = 'No data';
            el.appendChild(span);
        }
    }

    // Render all cards for a month
    function renderOccupancyCards(data, centres) {
        const row = document.getElementById('monthly-occupancy-row');
        row.innerHTML = '';
        const colors = { u2: '#0d8abc', o2: '#43a047', total: '#fbc02d' };
        centres.forEach((centre, idx) => {
            const centreData = data.find(d => d.centre_name === centre);
            let u2 = centreData && typeof centreData.u2 === 'number' ? centreData.u2 : null;
            let o2 = centreData && typeof centreData.o2 === 'number' ? centreData.o2 : null;
            let total = centreData && typeof centreData.total === 'number' ? centreData.total : null;
            let card = document.createElement('div');
            card.className = 'col-md-6 col-lg-4 mb-4';
            card.innerHTML = `
                <div class="card h-100 occupancy-card">
                    <div class="card-header p-0" style="background: linear-gradient(90deg, #1de9b6 0%, #1dc4e9 100%);">
                        <h5 class="m-0 p-3" style="color: #111;">${centre}</h5>
                    </div>
                    <div class="card-body d-flex flex-column align-items-center justify-content-center">
                        <div class="d-flex justify-content-center align-items-end w-100 mb-2 mt-4 flex-wrap" style="gap: 32px;">
                            <div class="text-center">
                                <div class="donut-container"><div id="donut-u2-${idx}" class="donut-chart"></div></div>
                                <div class="donut-label" style="color:${colors.u2}">U2</div>
                            </div>
                            <div class="text-center">
                                <div class="donut-container"><div id="donut-o2-${idx}" class="donut-chart"></div></div>
                                <div class="donut-label" style="color:${colors.o2}">O2</div>
                            </div>
                            <div class="text-center">
                                <div class="donut-container"><div id="donut-total-${idx}" class="donut-chart"></div></div>
                                <div class="donut-label" style="color:${colors.total}">Total</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            row.appendChild(card);
            renderDonutChart(`donut-u2-${idx}`, u2, colors.u2);
            renderDonutChart(`donut-o2-${idx}`, o2, colors.o2);
            renderDonutChart(`donut-total-${idx}`, total, colors.total);
        });
    }

    // Month navigation and data fetch
    let months = [];
    let currentMonthIdx = 0;
    const CENTRES = [
        "Papamoa Beach",
        "The Boulevard",
        "The Bach",
        "Terrace Views",
        "Livingstone Drive"
    ];

    async function fetchOccupancy(month) {
        // Update this URL to your Django API endpoint
        try {
            let resp = await fetch(`http://localhost:8000/api/occupancy/?month_year=${month}`);
            if (!resp.ok) {
                console.error('API request failed:', resp.status, resp.statusText);
                return [];
            }
            let json = await resp.json();
            console.log('API response for month', month, json);
            return json;
        } catch (err) {
            console.error('API fetch error:', err);
            return [];
        }
    }

    async function updateDashboard() {
        let month = months[currentMonthIdx];
        let data = await fetchOccupancy(month);
        // If no data for selected month, try previous months
        let triedMonths = 0;
        while ((!Array.isArray(data) || data.length === 0) && triedMonths < months.length) {
            console.warn('No occupancy data received for month', month);
            // Move to previous month
            if (currentMonthIdx > 0) {
                currentMonthIdx--;
                month = months[currentMonthIdx];
                data = await fetchOccupancy(month);
                triedMonths++;
            } else {
                break;
            }
        }
        document.getElementById('month-label').innerText = month;
        renderOccupancyCards(data, CENTRES);
        // Calculate and display averages
        let avg = getAverages(data);
        document.getElementById('avg-u2').innerText = `U2: ${avg.u2}`;
        document.getElementById('avg-o2').innerText = `O2: ${avg.o2}`;
        document.getElementById('avg-total').innerText = `Total: ${avg.total}`;
    }

    async function initOccupancyDashboard() {
        // Fetch months from API (or hardcode for now)
        // Example: months = ["04-2025", "05-2025", "06-2025", "07-2025"];
        // You can fetch all months from your API if available
        months = ["04-2025", "05-2025", "06-2025", "07-2025"];
        currentMonthIdx = months.length - 1;

        document.getElementById('month-back').onclick = () => {
            if (currentMonthIdx > 0) {
                currentMonthIdx--;
                updateDashboard();
            }
        };
        document.getElementById('month-forward').onclick = () => {
            if (currentMonthIdx < months.length - 1) {
                currentMonthIdx++;
                updateDashboard();
            }
        };

        await updateDashboard();
    }
    document.addEventListener('DOMContentLoaded', initOccupancyDashboard);
    </script>
{% endblock javascripts %}
