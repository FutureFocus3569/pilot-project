{% extends "layouts/base.html" %}

{% block title %} AI Agent {% endblock %}

{% block content %}
<div class="pc-container">
    <div class="pcoded-content">
        <h2 class="mb-4">AI Agent</h2>
        <p>This page will display AI agent features and integrations.</p>
        <div class="card mt-4" style="max-width: 600px; margin: 0 auto;">
            <div class="card-header text-white" style="background: linear-gradient(90deg, #1de9b6 0%, #1dc8e9 100%);">
                <h5 class="mb-0">AI Chat Agent</h5>
            </div>
            <div class="card-body" style="height: 350px; overflow-y: auto;" id="chat-box">
                <!-- Chat messages will appear here -->
            </div>
            <div class="card-footer">
                <form id="chat-form" autocomplete="off">
                    <div class="input-group">
                        <input type="text" id="chat-input" class="form-control" placeholder="Type your message..." required>
                        <button class="btn btn-primary" type="submit">Send</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Real AI chat integration
const chatBox = document.getElementById('chat-box');
const chatForm = document.getElementById('chat-form');
const chatInput = document.getElementById('chat-input');

chatForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const userMsg = chatInput.value.trim();
    if (!userMsg) return;
    appendMessage('You', userMsg, 'text-end');
    chatInput.value = '';
    appendMessage('AI', '<span class="spinner-border spinner-border-sm text-info" role="status"></span> Thinking...', 'text-start text-info ai-typing');
    try {
        const response = await fetch('/api/ai-agent-chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({ message: userMsg })
        });
        const data = await response.json();
        removeTyping();
        if (data.response) {
            appendMessage('AI', data.response, 'text-start text-primary');
        } else {
            appendMessage('AI', 'Sorry, I could not process your request.', 'text-start text-danger');
        }
    } catch (err) {
        removeTyping();
        appendMessage('AI', 'Error connecting to AI backend.', 'text-start text-danger');
    }
});

function appendMessage(sender, message, alignClass) {
    const msgDiv = document.createElement('div');
    msgDiv.className = `mb-2 ${alignClass}`;
    msgDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
    chatBox.appendChild(msgDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function removeTyping() {
    const typing = chatBox.querySelector('.ai-typing');
    if (typing) typing.remove();
}

// CSRF helper for Django
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock content %}
